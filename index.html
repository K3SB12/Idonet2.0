<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idonet Premium - Sistema de Gestión Académica</title>
    <meta name="description" content="Sistema de Gestión Académica compatible MEP Costa Rica, PNFT y SEA">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-title span {
            color: var(--primary-light);
        }

        .user-info {
            padding: 1rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .user-role {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-light);
            margin-bottom: 0.25rem;
        }

        .user-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.5);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-size: 0.9rem;
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            border-right: 3px solid var(--primary-light);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .nav-item.active .nav-icon,
        .nav-item:hover .nav-icon {
            opacity: 1;
        }

        /* Contenido Principal */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .top-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--dark);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue { background: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-content h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }

        .stat-content p {
            font-size: 0.875rem;
            color: var(--secondary);
            margin-top: 0.25rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-control:disabled {
            background: var(--light);
            cursor: not-allowed;
        }

        select.form-control {
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-row-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            background: var(--light);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .table tr:hover td {
            background: var(--light);
        }

        .table .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.375rem;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
        }

        .modal-close:hover {
            background: var(--light);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: var(--secondary);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--dark);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alertas */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Login */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 2rem;
        }

        .login-box {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }

        .login-header {
            background: var(--primary);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .login-header .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }

        .login-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .login-body {
            padding: 2rem;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* Charts Placeholder */
        .chart-container {
            height: 300px;
            background: var(--light);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
        }

        /* Rubric */
        .rubric-table th {
            background: var(--dark);
            color: white;
        }

        .rubric-cell {
            min-width: 100px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .d-flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Print Styles */
        @media print {
            .sidebar, .top-bar, .btn {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="logo">I</div>
                <h1>Idonet Premium</h1>
                <p>Sistema de Gestión Académica MEP Costa Rica</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="loginEmail" required placeholder="usuario@institucion.edu.cr">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginPassword" required placeholder="••••••••">
                    </div>
                    <div class="form-group">
                        <label class="toggle">
                            <input type="checkbox" id="rememberMe">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Recordar sesión</span>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        Iniciar Sesión
                    </button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <a href="#" onclick="app.showRegister()" style="color: var(--primary); text-decoration: none; font-size: 0.875rem;">
                        ¿No tiene cuenta? Regístrese aquí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <div class="logo">I</div>
                <h1>Registro de Usuario</h1>
                <p>Idonet Premium - MEP Costa Rica</p>
            </div>
            <div class="login-body">
                <form id="registerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Nombre</label>
                            <input type="text" class="form-control" id="regNombre" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Apellidos</label>
                            <input type="text" class="form-control" id="regApellidos" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Correo Electrónico</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Contraseña</label>
                            <input type="password" class="form-control" id="regPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Confirmar Contraseña</label>
                            <input type="password" class="form-control" id="regPasswordConfirm" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Rol</label>
                        <select class="form-control" id="regRol" required>
                            <option value="">Seleccione...</option>
                            <option value="docente">Docente</option>
                            <option value="coordinador">Coordinador</option>
                            <option value="director">Director</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group" id="regCodigoGrupo" style="display: none;">
                        <label class="form-label">Código de Grupo (si aplica)</label>
                        <input type="text" class="form-control" placeholder="Ej: 10-1, 11-A">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        Crear Cuenta
                    </button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <a href="#" onclick="app.showLogin()" style="color: var(--primary); text-decoration: none; font-size: 0.875rem;">
                        ← Volver al inicio de sesión
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">I</div>
                <div class="sidebar-title">Idonet <span>Premium</span></div>
            </div>
            
            <div class="user-info">
                <div class="user-role" id="userRoleDisplay">Rol</div>
                <div class="user-name" id="userNameDisplay">Nombre Usuario</div>
            </div>

            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <button class="nav-item active" onclick="app.navigate('dashboard')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                        Dashboard
                    </button>
                    <button class="nav-item" onclick="app.navigate('configuracion')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Configuración
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Gestión Académica</div>
                    <button class="nav-item" onclick="app.navigate('grupos')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Grupos y Estudiantes
                    </button>
                    <button class="nav-item" onclick="app.navigate('evaluacion')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                        Evaluación General
                    </button>
                    <button class="nav-item" onclick="app.navigate('pnft')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Prueba Ejecución PNFT
                    </button>
                    <button class="nav-item" onclick="app.navigate('nee')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                        Módulo NEE
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Herramientas</div>
                    <button class="nav-item" onclick="app.navigate('indicadores')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Banco de Indicadores
                    </button>
                    <button class="nav-item" onclick="app.navigate('reportes')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Reportería
                    </button>
                    <button class="nav-item" onclick="app.navigate('exportar')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Exportar SEA
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Sistema</div>
                    <button class="nav-item" onclick="app.navigate('usuarios')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        Usuarios
                    </button>
                    <button class="nav-item" onclick="app.navigate('respaldo')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        Respaldo y Seguridad
                    </button>
                    <button class="nav-item" onclick="app.logout()">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Cerrar Sesión
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="top-actions">
                    <button class="btn btn-secondary" onclick="app.toggleSidebar()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <span id="currentYear" class="badge badge-info">2025</span>
                </div>
            </header>

            <div class="content-area" id="contentArea">
                <!-- Views will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modalOverlay" onclick="app.closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Título</h3>
                <button class="modal-close" onclick="app.closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modalConfirm">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Idonet Premium - Sistema de Gestión Académica
         * Compatible MEP Costa Rica, PNFT y SEA
         * 
         * @version 1.0.0
         * @author Sistema Idonet
         */

        // ==========================================
        // CONFIGURACIÓN Y UTILIDADES
        // ==========================================

        const CONFIG = {
            DB_NAME: 'IdonetPremiumDB',
            DB_VERSION: 1,
            APP_VERSION: '1.0.0',
            DEFAULT_YEAR: new Date().getFullYear(),
            MIN_NOTE: 0,
            MAX_NOTE: 100,
            APPROVAL_THRESHOLD: 65,
            DECIMAL_PLACES: 2
        };

        const ROLES = {
            DOCENTE: 'docente',
            COORDINADOR: 'coordinador',
            DIRECTOR: 'director',
            ADMIN: 'admin'
        };

        const PERMISSIONS = {
            [ROLES.DOCENTE]: ['dashboard', 'grupos', 'evaluacion', 'pnft', 'reportes'],
            [ROLES.COORDINADOR]: ['dashboard', 'grupos', 'evaluacion', 'pnft', 'nee', 'indicadores', 'reportes', 'exportar'],
            [ROLES.DIRECTOR]: ['dashboard', 'configuracion', 'grupos', 'evaluacion', 'pnft', 'nee', 'indicadores', 'reportes', 'exportar', 'usuarios'],
            [ROLES.ADMIN]: ['*']
        };

        // Utilidades
        const utils = {
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            formatDate: (date) => new Date(date).toLocaleDateString('es-CR'),
            
            formatNumber: (num, decimals = CONFIG.DECIMAL_PLACES) => {
                return parseFloat(num).toFixed(decimals);
            },
            
            validateEmail: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
            
            validateRange: (value, min, max) => value >= min && value <= max,
            
            calculateWeightedAverage: (values, weights) => {
                let sum = 0;
                let weightSum = 0;
                for (let i = 0; i < values.length; i++) {
                    sum += values[i] * weights[i];
                    weightSum += weights[i];
                }
                return weightSum > 0 ? sum / weightSum : 0;
            },
            
            round: (num, decimals = CONFIG.DECIMAL_PLACES) => {
                const factor = Math.pow(10, decimals);
                return Math.round(num * factor) / factor;
            },
            
            downloadFile: (content, filename, type) => {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ==========================================
        // BASE DE DATOS INDEXEDDB
        // ==========================================

        class Database {
            constructor() {
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Stores
                        if (!db.objectStoreNames.contains('users')) {
                            const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                            usersStore.createIndex('email', 'email', { unique: true });
                        }

                        if (!db.objectStoreNames.contains('config')) {
                            db.createObjectStore('config', { keyPath: 'key' });
                        }

                        if (!db.objectStoreNames.contains('grupos')) {
                            db.createObjectStore('grupos', { keyPath: 'id' });
                        }

                        if (!db.objectStoreNames.contains('estudiantes')) {
                            const estStore = db.createObjectStore('estudiantes', { keyPath: 'id' });
                            estStore.createIndex('grupoId', 'grupoId', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('evaluaciones')) {
                            const evalStore = db.createObjectStore('evaluaciones', { keyPath: 'id' });
                            evalStore.createIndex('estudianteId', 'estudianteId', { unique: false });
                            evalStore.createIndex('periodo', 'periodo', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('pnft')) {
                            db.createObjectStore('pnft', { keyPath: 'id' });
                        }

                        if (!db.objectStoreNames.contains('indicadores')) {
                            db.createObjectStore('indicadores', { keyPath: 'id' });
                        }

                        if (!db.objectStoreNames.contains('historial')) {
                            db.createObjectStore('historial', { keyPath: 'id' });
                        }
                    };
                });
            }

            async get(store, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(store) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(store, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(store, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getByIndex(store, indexName, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    const index = objectStore.index(indexName);
                    const request = index.getAll(value);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(store) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        const db = new Database();

        // ==========================================
        // SERVICIOS DE NEGOCIO
        // ==========================================

        class AuthService {
            constructor() {
                this.currentUser = null;
            }

            async register(userData) {
                const existing = await db.get('users', userData.email);
                if (existing) throw new Error('El correo ya está registrado');

                const user = {
                    id: utils.generateId(),
                    ...userData,
                    createdAt: new Date().toISOString(),
                    active: true
                };

                await db.put('users', user);
                return user;
            }

            async login(email, password) {
                const users = await db.getAll('users');
                const user = users.find(u => u.email === email && u.password === password);
                
                if (!user) throw new Error('Credenciales inválidas');
                if (!user.active) throw new Error('Usuario inactivo');

                this.currentUser = user;
                localStorage.setItem('idonet_session', JSON.stringify({
                    userId: user.id,
                    timestamp: Date.now()
                }));

                return user;
            }

            async checkSession() {
                const session = localStorage.getItem('idonet_session');
                if (!session) return null;

                const { userId } = JSON.parse(session);
                const user = await db.get('users', userId);
                
                if (user) {
                    this.currentUser = user;
                    return user;
                }
                
                return null;
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('idonet_session');
            }

            hasPermission(module) {
                if (!this.currentUser) return false;
                const perms = PERMISSIONS[this.currentUser.rol] || [];
                return perms.includes('*') || perms.includes(module);
            }
        }

        class ConfigService {
            async getConfig() {
                let config = await db.get('config', 'institucional');
                if (!config) {
                    config = this.getDefaultConfig();
                    await db.put('config', { key: 'institucional', ...config });
                }
                return config;
            }

            getDefaultConfig() {
                return {
                    key: 'institucional',
                    nombreInstitucion: '',
                    codigoMEP: '',
                    modalidad: 'academica', // academica | tecnica
                    añoLectivo: CONFIG.DEFAULT_YEAR,
                    periodos: [
                        { id: 1, nombre: 'Primer Periodo', inicio: '', fin: '' },
                        { id: 2, nombre: 'Segundo Periodo', inicio: '', fin: '' },
                        { id: 3, nombre: 'Tercer Periodo', inicio: '', fin: '' }
                    ],
                    componentes: [
                        { id: 'saber', nombre: 'Saber', porcentaje: 40 },
                        { id: 'hacer', nombre: 'Hacer', porcentaje: 40 },
                        { id: 'ser', nombre: 'Ser', porcentaje: 20 }
                    ],
                    redondeo: 'normal', // normal | matematico | truncado
                    decimales: 2,
                    escala: '0-100' // 0-100 | 0-10
                };
            }

            async saveConfig(config) {
                await db.put('config', config);
            }

            validateComponentes(componentes) {
                const total = componentes.reduce((sum, c) => sum + parseFloat(c.porcentaje), 0);
                return Math.abs(total - 100) < 0.01;
            }
        }

        class EstudianteService {
            async createGrupo(grupoData) {
                const grupo = {
                    id: utils.generateId(),
                    ...grupoData,
                    createdAt: new Date().toISOString()
                };
                await db.put('grupos', grupo);
                return grupo;
            }

            async getGrupos() {
                return await db.getAll('grupos');
            }

            async createEstudiante(estData) {
                const estudiante = {
                    id: utils.generateId(),
                    ...estData,
                    historial: [],
                    createdAt: new Date().toISOString()
                };
                await db.put('estudiantes', estudiante);
                return estudiante;
            }

            async getEstudiantesByGrupo(grupoId) {
                return await db.getByIndex('estudiantes', 'grupoId', grupoId);
            }

            async updateEstudiante(id, updates) {
                const estudiante = await db.get('estudiantes', id);
                if (!estudiante) throw new Error('Estudiante no encontrado');
                
                const updated = { ...estudiante, ...updates, updatedAt: new Date().toISOString() };
                await db.put('estudiantes', updated);
                return updated;
            }

            async deleteEstudiante(id) {
                // Verificar dependencias
                const evaluaciones = await db.getByIndex('evaluaciones', 'estudianteId', id);
                if (evaluaciones.length > 0) {
                    throw new Error('No se puede eliminar: tiene evaluaciones registradas');
                }
                await db.delete('estudiantes', id);
            }
        }

        class EvaluacionService {
            async registrarEvaluacion(evalData) {
                // Validar rango
                if (!utils.validateRange(evalData.nota, CONFIG.MIN_NOTE, CONFIG.MAX_NOTE)) {
                    throw new Error(`La nota debe estar entre ${CONFIG.MIN_NOTE} y ${CONFIG.MAX_NOTE}`);
                }

                const evaluacion = {
                    id: utils.generateId(),
                    ...evalData,
                    createdAt: new Date().toISOString()
                };

                await db.put('evaluaciones', evaluacion);
                
                // Actualizar historial del estudiante
                await this.actualizarHistorial(evalData.estudianteId);
                
                return evaluacion;
            }

            async getEvaluacionesByEstudiante(estudianteId) {
                return await db.getByIndex('evaluaciones', 'estudianteId', estudianteId);
            }

            async calcularPromedioPeriodo(estudianteId, periodo) {
                const evaluaciones = await this.getEvaluacionesByEstudiante(estudianteId);
                const periodoEvals = evaluaciones.filter(e => e.periodo === periodo);
                
                if (periodoEvals.length === 0) return null;

                const config = await new ConfigService().getConfig();
                const componentes = config.componentes;

                let totalPonderado = 0;
                let totalPeso = 0;

                componentes.forEach(comp => {
                    const evalComp = periodoEvals.filter(e => e.componente === comp.id);
                    if (evalComp.length > 0) {
                        const promedioComp = evalComp.reduce((sum, e) => sum + e.nota, 0) / evalComp.length;
                        totalPonderado += promedioComp * (comp.porcentaje / 100);
                        totalPeso += comp.porcentaje;
                    }
                });

                return totalPeso > 0 ? utils.round(totalPonderado) : null;
            }

            async calcularPromedioAnual(estudianteId) {
                const config = await new ConfigService().getConfig();
                const promedios = [];
                
                for (const periodo of config.periodos) {
                    const prom = await this.calcularPromedioPeriodo(estudianteId, periodo.id);
                    if (prom !== null) promedios.push(prom);
                }

                if (promedios.length === 0) return null;
                
                const promedioAnual = promedios.reduce((a, b) => a + b, 0) / promedios.length;
                return utils.round(promedioAnual);
            }

            async actualizarHistorial(estudianteId) {
                const estudiante = await db.get('estudiantes', estudianteId);
                const promedioAnual = await this.calcularPromedioAnual(estudianteId);
                
                if (promedioAnual !== null) {
                    estudiante.historial.push({
                        año: CONFIG.DEFAULT_YEAR,
                        promedio: promedioAnual,
                        fecha: new Date().toISOString()
                    });
                    await db.put('estudiantes', estudiante);
                }
            }
        }

        class PNFTService {
            async createRubrica(rubricaData) {
                const rubrica = {
                    id: utils.generateId(),
                    ...rubricaData,
                    createdAt: new Date().toISOString()
                };
                await db.put('pnft', rubrica);
                return rubrica;
            }

            async getRubricas() {
                return await db.getAll('pnft');
            }

            async calcularPuntuacion(rubricaId, puntuaciones) {
                const rubrica = await db.get('pnft', rubricaId);
                if (!rubrica) throw new Error('Rúbrica no encontrada');

                let total = 0;
                let maximo = 0;

                rubrica.criterios.forEach((criterio, index) => {
                    const puntaje = puntuaciones[index] || 0;
                    total += puntaje * (criterio.ponderacion / 100);
                    maximo += criterio.maximo * (criterio.ponderacion / 100);
                });

                return {
                    puntuacion: utils.round(total),
                    maximo: utils.round(maximo),
                    porcentaje: utils.round((total / maximo) * 100)
                };
            }
        }

        class IndicadorService {
            async create(indicadorData) {
                const indicador = {
                    id: utils.generateId(),
                    ...indicadorData,
                    createdAt: new Date().toISOString()
                };
                await db.put('indicadores', indicador);
                return indicador;
            }

            async getAll() {
                return await db.getAll('indicadores');
            }

            async importCSV(csvContent) {
                const lines = csvContent.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const indicadores = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.trim());
                    const indicador = {};
                    
                    headers.forEach((header, index) => {
                        indicador[header] = values[index];
                    });

                    indicador.id = utils.generateId();
                    indicador.createdAt = new Date().toISOString();
                    
                    await db.put('indicadores', indicador);
                    indicadores.push(indicador);
                }

                return indicadores;
            }

            exportToCSV(indicadores) {
                if (indicadores.length === 0) return '';
                
                const headers = Object.keys(indicadores[0]).filter(k => k !== 'id' && k !== 'createdAt');
                const csv = [
                    headers.join(','),
                    ...indicadores.map(ind => headers.map(h => ind[h]).join(','))
                ].join('\n');

                return csv;
            }
        }

        class ReporteService {
            async generarReporteIndividual(estudianteId) {
                const estudiante = await db.get('estudiantes', estudianteId);
                const evaluaciones = await new EvaluacionService().getEvaluacionesByEstudiante(estudianteId);
                const promedioAnual = await new EvaluacionService().calcularPromedioAnual(estudianteId);

                return {
                    estudiante,
                    evaluaciones,
                    promedioAnual,
                    condicion: promedioAnual >= CONFIG.APPROVAL_THRESHOLD ? 'Aprobado' : 'Reprobado',
                    fechaGeneracion: new Date().toISOString()
                };
            }

            async generarReporteGrupal(grupoId) {
                const estudiantes = await new EstudianteService().getEstudiantesByGrupo(grupoId);
                const resultados = [];

                for (const est of estudiantes) {
                    const promedio = await new EvaluacionService().calcularPromedioAnual(est.id);
                    resultados.push({
                        estudiante: est,
                        promedio,
                        condicion: promedio >= CONFIG.APPROVAL_THRESHOLD ? 'Aprobado' : 'Reprobado'
                    });
                }

                const aprobados = resultados.filter(r => r.condicion === 'Aprobado').length;
                const promedioGrupo = resultados.reduce((sum, r) => sum + (r.promedio || 0), 0) / resultados.length;

                return {
                    estudiantes: resultados,
                    estadisticas: {
                        total: resultados.length,
                        aprobados,
                        reprobados: resultados.length - aprobados,
                        porcentajeAprobacion: utils.round((aprobados / resultados.length) * 100),
                        promedioGrupo: utils.round(promedioGrupo)
                    },
                    fechaGeneracion: new Date().toISOString()
                };
            }

            exportToPDF(data, tipo) {
                // Generar HTML para impresión/PDF
                const html = this.generarHTMLReporte(data, tipo);
                const ventana = window.open('', '_blank');
                ventana.document.write(html);
                ventana.document.close();
                ventana.print();
            }

            generarHTMLReporte(data, tipo) {
                const config = { nombreInstitucion: 'Institución Educativa' }; // Simplificado
                
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Reporte ${tipo}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 2cm; }
                            .header { text-align: center; margin-bottom: 2rem; }
                            .title { font-size: 1.5rem; font-weight: bold; }
                            table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                            th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
                            th { background: #f5f5f5; }
                            .footer { margin-top: 2rem; font-size: 0.8rem; color: #666; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="title">${config.nombreInstitucion}</div>
                            <div>Reporte ${tipo} - ${new Date().toLocaleDateString('es-CR')}</div>
                        </div>
                        <div class="content">
                            ${tipo === 'Individual' ? this.generarTablaIndividual(data) : this.generarTablaGrupal(data)}
                        </div>
                        <div class="footer">
                            Generado por Idonet Premium - Sistema de Gestión Académica MEP Costa Rica
                        </div>
                    </body>
                    </html>
                `;
            }

            generarTablaIndividual(data) {
                return `
                    <h2>${data.estudiante.nombre} ${data.estudiante.apellidos}</h2>
                    <p><strong>Identificación:</strong> ${data.estudiante.identificacion}</p>
                    <p><strong>Promedio Anual:</strong> ${data.promedioAnual}</p>
                    <p><strong>Condición:</strong> ${data.condicion}</p>
                    <h3>Evaluaciones</h3>
                    <table>
                        <tr>
                            <th>Periodo</th>
                            <th>Componente</th>
                            <th>Nota</th>
                        </tr>
                        ${data.evaluaciones.map(e => `
                            <tr>
                                <td>${e.periodo}</td>
                                <td>${e.componente}</td>
                                <td>${e.nota}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }

            generarTablaGrupal(data) {
                return `
                    <h2>Reporte Grupal</h2>
                    <p><strong>Total Estudiantes:</strong> ${data.estadisticas.total}</p>
                    <p><strong>Aprobados:</strong> ${data.estadisticas.aprobados} (${data.estadisticas.porcentajeAprobacion}%)</p>
                    <p><strong>Promedio Grupo:</strong> ${data.estadisticas.promedioGrupo}</p>
                    <table>
                        <tr>
                            <th>Estudiante</th>
                            <th>Identificación</th>
                            <th>Promedio</th>
                            <th>Condición</th>
                        </tr>
                        ${data.estudiantes.map(e => `
                            <tr>
                                <td>${e.estudiante.nombre} ${e.estudiante.apellidos}</td>
                                <td>${e.estudiante.identificacion}</td>
                                <td>${e.promedio}</td>
                                <td>${e.condicion}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
        }

        class SEAService {
            async exportarDatos() {
                const estudiantes = await db.getAll('estudiantes');
                const evaluaciones = await db.getAll('evaluaciones');
                const config = await new ConfigService().getConfig();

                const datosSEA = estudiantes.map(est => {
                    const evalsEst = evaluaciones.filter(e => e.estudianteId === est.id);
                    const notasPorPeriodo = {};

                    config.periodos.forEach(periodo => {
                        const evalsPeriodo = evalsEst.filter(e => e.periodo === periodo.id);
                        const promedio = evalsPeriodo.length > 0 
                            ? evalsPeriodo.reduce((sum, e) => sum + e.nota, 0) / evalsPeriodo.length 
                            : null;
                        notasPorPeriodo[`periodo_${periodo.id}`] = promedio ? utils.round(promedio) : '';
                    });

                    return {
                        identificacion: est.identificacion,
                        nombre: est.nombre,
                        apellido1: est.apellidos.split(' ')[0] || '',
                        apellido2: est.apellidos.split(' ')[1] || '',
                        grupo: est.grupoId,
                        ...notasPorPeriodo,
                        condicion: est.historial.length > 0 ? est.historial[est.historial.length - 1].promedio >= CONFIG.APPROVAL_THRESHOLD ? 'A' : 'R' : ''
                    };
                });

                return datosSEA;
            }

            validarDatosSEA(datos) {
                const errores = [];
                
                datos.forEach((registro, index) => {
                    if (!registro.identificacion) {
                        errores.push(`Fila ${index + 1}: Identificación requerida`);
                    }
                    
                    Object.keys(registro).forEach(key => {
                        if (key.startsWith('periodo_') && registro[key] !== '') {
                            const nota = parseFloat(registro[key]);
                            if (isNaN(nota) || nota < CONFIG.MIN_NOTE || nota > CONFIG.MAX_NOTE) {
                                errores.push(`Fila ${index + 1}: Nota inválida en ${key}`);
                            }
                        }
                    });
                });

                return {
                    valido: errores.length === 0,
                    errores
                };
            }

            generarCSV(datos) {
                if (datos.length === 0) return '';
                
                const headers = Object.keys(datos[0]);
                const csv = [
                    headers.join(','),
                    ...datos.map(row => headers.map(h => {
                        const val = row[h];
                        return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                    }).join(','))
                ].join('\n');

                return csv;
            }
        }

        class BackupService {
            async exportarBackup() {
                const data = {
                    version: CONFIG.APP_VERSION,
                    fecha: new Date().toISOString(),
                    usuarios: await db.getAll('users'),
                    configuracion: await db.get('config', 'institucional'),
                    grupos: await db.getAll('grupos'),
                    estudiantes: await db.getAll('estudiantes'),
                    evaluaciones: await db.getAll('evaluaciones'),
                    pnft: await db.getAll('pnft'),
                    indicadores: await db.getAll('indicadores')
                };

                return JSON.stringify(data, null, 2);
            }

            async importarBackup(jsonContent) {
                try {
                    const data = JSON.parse(jsonContent);
                    
                    if (!data.version) throw new Error('Archivo de respaldo inválido');

                    // Confirmar antes de sobrescribir
                    if (!confirm('¿Está seguro de restaurar este respaldo? Se sobrescribirán todos los datos actuales.')) {
                        return false;
                    }

                    // Limpiar y restaurar
                    await db.clear('users');
                    await db.clear('grupos');
                    await db.clear('estudiantes');
                    await db.clear('evaluaciones');
                    await db.clear('pnft');
                    await db.clear('indicadores');

                    // Restaurar datos
                    if (data.usuarios) {
                        for (const user of data.usuarios) await db.put('users', user);
                    }
                    if (data.configuracion) {
                        await db.put('config', data.configuracion);
                    }
                    if (data.grupos) {
                        for (const grupo of data.grupos) await db.put('grupos', grupo);
                    }
                    if (data.estudiantes) {
                        for (const est of data.estudiantes) await db.put('estudiantes', est);
                    }
                    if (data.evaluaciones) {
                        for (const eval of data.evaluaciones) await db.put('evaluaciones', eval);
                    }
                    if (data.pnft) {
                        for (const p of data.pnft) await db.put('pnft', p);
                    }
                    if (data.indicadores) {
                        for (const ind of data.indicadores) await db.put('indicadores', ind);
                    }

                    return true;
                } catch (error) {
                    throw new Error('Error al importar: ' + error.message);
                }
            }
        }

        // ==========================================
        // APLICACIÓN PRINCIPAL
        // ==========================================

        class App {
            constructor() {
                this.auth = new AuthService();
                this.configService = new ConfigService();
                this.estudianteService = new EstudianteService();
                this.evaluacionService = new EvaluacionService();
                this.pnftService = new PNFTService();
                this.indicadorService = new IndicadorService();
                this.reporteService = new ReporteService();
                this.seaService = new SEAService();
                this.backupService = new BackupService();
                
                this.currentView = 'dashboard';
                this.sidebarOpen = true;
            }

            async init() {
                try {
                    await db.init();
                    console.log('Base de datos inicializada');
                    
                    // Verificar sesión
                    const user = await this.auth.checkSession();
                    if (user) {
                        this.showMainApp();
                    } else {
                        this.showLogin();
                    }

                    // Configurar eventos
                    this.setupEventListeners();
                    
                    // Registrar Service Worker
                    this.registerSW();
                } catch (error) {
                    console.error('Error inicializando aplicación:', error);
                    this.showToast('Error al inicializar la aplicación', 'error');
                }
            }

            setupEventListeners() {
                // Login
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // Registro
                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleRegister();
                });

                // Cambio de rol en registro
                document.getElementById('regRol').addEventListener('change', (e) => {
                    const codigoGrupo = document.getElementById('regCodigoGrupo');
                    codigoGrupo.style.display = e.target.value === 'docente' ? 'block' : 'none';
                });
            }

            async registerSW() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('service-worker.js');
                        console.log('Service Worker registrado:', registration);
                    } catch (error) {
                        console.log('Error registrando Service Worker:', error);
                    }
                }
            }

            // Navegación
            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            showRegister() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('registerScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Actualizar UI con datos del usuario
                document.getElementById('userRoleDisplay').textContent = this.auth.currentUser.rol;
                document.getElementById('userNameDisplay').textContent = 
                    `${this.auth.currentUser.nombre} ${this.auth.currentUser.apellidos}`;
                
                // Cargar vista inicial
                this.navigate('dashboard');
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    await this.auth.login(email, password);
                    this.showToast('Inicio de sesión exitoso', 'success');
                    this.showMainApp();
                } catch (error) {
                    this.showToast(error.message, 'error');
                }
            }

            async handleRegister() {
                const password = document.getElementById('regPassword').value;
                const passwordConfirm = document.getElementById('regPasswordConfirm').value;

                if (password !== passwordConfirm) {
                    this.showToast('Las contraseñas no coinciden', 'error');
                    return;
                }

                const userData = {
                    nombre: document.getElementById('regNombre').value,
                    apellidos: document.getElementById('regApellidos').value,
                    email: document.getElementById('regEmail').value,
                    password: password,
                    rol: document.getElementById('regRol').value
                };

                try {
                    await this.auth.register(userData);
                    this.showToast('Usuario registrado exitosamente', 'success');
                    this.showLogin();
                } catch (error) {
                    this.showToast(error.message, 'error');
                }
            }

            logout() {
                this.auth.logout();
                this.showLogin();
                this.showToast('Sesión cerrada', 'success');
            }

            // Navegación entre módulos
            navigate(view) {
                if (!this.auth.hasPermission(view)) {
                    this.showToast('No tiene permisos para acceder a este módulo', 'error');
                    return;
                }

                this.currentView = view;
                
                // Actualizar navegación activa
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event?.target?.classList.add('active');

                // Cargar contenido
                this.loadView(view);
            }

            async loadView(view) {
                const contentArea = document.getElementById('contentArea');
                const pageTitle = document.getElementById('pageTitle');
                
                const titles = {
                    dashboard: 'Dashboard',
                    configuracion: 'Configuración Institucional',
                    grupos: 'Gestión de Grupos y Estudiantes',
                    evaluacion: 'Evaluación General',
                    pnft: 'Prueba de Ejecución PNFT',
                    nee: 'Módulo NEE',
                    indicadores: 'Banco de Indicadores',
                    reportes: 'Reportería Avanzada',
                    exportar: 'Exportación SEA',
                    usuarios: 'Gestión de Usuarios',
                    respaldo: 'Respaldo y Seguridad'
                };

                pageTitle.textContent = titles[view] || view;

                switch(view) {
                    case 'dashboard':
                        contentArea.innerHTML = await this.renderDashboard();
                        break;
                    case 'configuracion':
                        contentArea.innerHTML = await this.renderConfiguracion();
                        break;
                    case 'grupos':
                        contentArea.innerHTML = await this.renderGrupos();
                        break;
                    case 'evaluacion':
                        contentArea.innerHTML = await this.renderEvaluacion();
                        break;
                    case 'pnft':
                        contentArea.innerHTML = await this.renderPNFT();
                        break;
                    case 'nee':
                        contentArea.innerHTML = await this.renderNEE();
                        break;
                    case 'indicadores':
                        contentArea.innerHTML = await this.renderIndicadores();
                        break;
                    case 'reportes':
                        contentArea.innerHTML = await this.renderReportes();
                        break;
                    case 'exportar':
                        contentArea.innerHTML = await this.renderExportar();
                        break;
                    case 'usuarios':
                        contentArea.innerHTML = await this.renderUsuarios();
                        break;
                    case 'respaldo':
                        contentArea.innerHTML = await this.renderRespaldo();
                        break;
                    default:
                        contentArea.innerHTML = '<div class="card"><div class="card-body">Módulo en desarrollo</div></div>';
                }
            }

            // Renderizado de Vistas
            async renderDashboard() {
                const grupos = await this.estudianteService.getGrupos();
                const estudiantes = await db.getAll('estudiantes');
                const evaluaciones = await db.getAll('evaluaciones');
                
                // Calcular estadísticas
                const bajo65 = estudiantes.filter(e => {
                    const prom = e.historial.length > 0 ? e.historial[e.historial.length - 1].promedio : 100;
                    return prom < 65;
                }).length;

                return `
                    <div class="grid grid-4">
                        <div class="stat-card">
                            <div class="stat-icon blue">👥</div>
                            <div class="stat-content">
                                <h3>${grupos.length}</h3>
                                <p>Grupos Activos</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">🎓</div>
                            <div class="stat-content">
                                <h3>${estudiantes.length}</h3>
                                <p>Estudiantes</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">📝</div>
                            <div class="stat-content">
                                <h3>${evaluaciones.length}</h3>
                                <p>Evaluaciones</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">⚠️</div>
                            <div class="stat-content">
                                <h3>${bajo65}</h3>
                                <p>Alertas < 65</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-2" style="margin-top: 1.5rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Distribución de Notas</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    [Gráfico de Distribución]
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Promedios por Periodo</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    [Gráfico de Promedios]
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">Alertas Académicas</h3>
                        </div>
                        <div class="card-body">
                            ${bajo65 > 0 ? `
                                <div class="alert alert-warning">
                                    <strong>Atención:</strong> ${bajo65} estudiantes con promedio inferior a 65.
                                </div>
                            ` : `
                                <div class="alert alert-success">
                                    No hay alertas académicas pendientes.
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            async renderConfiguracion() {
                const config = await this.configService.getConfig();
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Configuración Institucional</h3>
                        </div>
                        <div class="card-body">
                            <form id="configForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Nombre de la Institución</label>
                                        <input type="text" class="form-control" id="confNombre" value="${config.nombreInstitucion}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Código MEP</label>
                                        <input type="text" class="form-control" id="confCodigoMEP" value="${config.codigoMEP}" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Modalidad</label>
                                        <select class="form-control" id="confModalidad" required>
                                            <option value="academica" ${config.modalidad === 'academica' ? 'selected' : ''}>Académica</option>
                                            <option value="tecnica" ${config.modalidad === 'tecnica' ? 'selected' : ''}>Técnica</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Año Lectivo</label>
                                        <input type="number" class="form-control" id="confAño" value="${config.añoLectivo}" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Periodos del Año Lectivo</label>
                                    <div id="periodosContainer">
                                        ${config.periodos.map((p, i) => `
                                            <div class="form-row" style="margin-bottom: 0.5rem;">
                                                <input type="text" class="form-control" placeholder="Nombre" value="${p.nombre}" data-periodo="${i}" data-field="nombre">
                                                <input type="date" class="form-control" value="${p.inicio}" data-periodo="${i}" data-field="inicio">
                                                <input type="date" class="form-control" value="${p.fin}" data-periodo="${i}" data-field="fin">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Componentes de Evaluación (deben sumar 100%)</label>
                                    <div id="componentesContainer">
                                        ${config.componentes.map((c, i) => `
                                            <div class="form-row" style="margin-bottom: 0.5rem;">
                                                <input type="text" class="form-control" placeholder="ID" value="${c.id}" data-componente="${i}" data-field="id">
                                                <input type="text" class="form-control" placeholder="Nombre" value="${c.nombre}" data-componente="${i}" data-field="nombre">
                                                <input type="number" class="form-control" placeholder="%" value="${c.porcentaje}" data-componente="${i}" data-field="porcentaje" min="0" max="100">
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div id="componentesError" class="alert alert-danger hidden" style="margin-top: 0.5rem;">
                                        La suma de porcentajes debe ser exactamente 100%
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Tipo de Redondeo</label>
                                        <select class="form-control" id="confRedondeo">
                                            <option value="normal" ${config.redondeo === 'normal' ? 'selected' : ''}>Normal</option>
                                            <option value="matematico" ${config.redondeo === 'matematico' ? 'selected' : ''}>Matemático</option>
                                            <option value="truncado" ${config.redondeo === 'truncado' ? 'selected' : ''}>Truncado</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Decimales</label>
                                        <input type="number" class="form-control" id="confDecimales" value="${config.decimales}" min="0" max="4">
                                    </div>
                                </div>

                                <div class="d-flex justify-between items-center" style="margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" onclick="app.navigate('dashboard')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            async renderGrupos() {
                const grupos = await this.estudianteService.getGrupos();
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Grupos</h3>
                            <button class="btn btn-primary" onclick="app.showModalCrearGrupo()">
                                + Nuevo Grupo
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Nivel</th>
                                            <th>Sección</th>
                                            <th>Año</th>
                                            <th>Estudiantes</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${grupos.length === 0 ? `
                                            <tr>
                                                <td colspan="6" class="text-center">No hay grupos registrados</td>
                                            </tr>
                                        ` : grupos.map(g => `
                                            <tr>
                                                <td>${g.codigo}</td>
                                                <td>${g.nivel}</td>
                                                <td>${g.seccion}</td>
                                                <td>${g.año}</td>
                                                <td>${g.estudiantes || 0}</td>
                                                <td class="actions">
                                                    <button class="btn btn-sm btn-secondary" onclick="app.verEstudiantes('${g.id}')">Ver</button>
                                                    <button class="btn btn-sm btn-primary" onclick="app.editarGrupo('${g.id}')">Editar</button>
                                                    <button class="btn btn-sm btn-danger" onclick="app.eliminarGrupo('${g.id}')">Eliminar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderEvaluacion() {
                const grupos = await this.estudianteService.getGrupos();
                const config = await this.configService.getConfig();
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Registro de Evaluación</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Grupo</label>
                                    <select class="form-control" id="evalGrupo" onchange="app.cargarEstudiantesEval()">
                                        <option value="">Seleccione...</option>
                                        ${grupos.map(g => `<option value="${g.id}">${g.codigo}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Periodo</label>
                                    <select class="form-control" id="evalPeriodo">
                                        ${config.periodos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Componente</label>
                                    <select class="form-control" id="evalComponente">
                                        ${config.componentes.map(c => `<option value="${c.id}">${c.nombre} (${c.porcentaje}%)</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div id="tablaEvaluacion" style="margin-top: 1.5rem;">
                                <p class="text-center" style="color: var(--secondary);">
                                    Seleccione un grupo para cargar los estudiantes
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderPNFT() {
                const rubricas = await this.pnftService.getRubricas();
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Prueba de Ejecución PNFT</h3>
                            <button class="btn btn-primary" onclick="app.showModalCrearRubrica()">
                                + Nueva Rúbrica
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Competencia</th>
                                            <th>Criterios</th>
                                            <th>Clasificación</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rubricas.length === 0 ? `
                                            <tr>
                                                <td colspan="5" class="text-center">No hay rúbricas registradas</td>
                                            </tr>
                                        ` : rubricas.map(r => `
                                            <tr>
                                                <td>${r.nombre}</td>
                                                <td>${r.competencia}</td>
                                                <td>${r.criterios?.length || 0}</td>
                                                <td><span class="badge badge-info">${r.clasificacion || 'N/A'}</span></td>
                                                <td class="actions">
                                                    <button class="btn btn-sm btn-secondary" onclick="app.aplicarRubrica('${r.id}')">Aplicar</button>
                                                    <button class="btn btn-sm btn-primary" onclick="app.editarRubrica('${r.id}')">Editar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderNEE() {
                const estudiantes = await db.getAll('estudiantes');
                const estudiantesNEE = estudiantes.filter(e => e.adaptacionNEE);
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Estudiantes con Necesidades Educativas Especiales</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Estudiante</th>
                                            <th>Identificación</th>
                                            <th>Tipo de Adecuación</th>
                                            <th>Ajustes Aplicados</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${estudiantesNEE.length === 0 ? `
                                            <tr>
                                                <td colspan="5" class="text-center">No hay estudiantes NEE registrados</td>
                                            </tr>
                                        ` : estudiantesNEE.map(e => `
                                            <tr>
                                                <td>${e.nombre} ${e.apellidos}</td>
                                                <td>${e.identificacion}</td>
                                                <td>${e.tipoNEE || 'No especificado'}</td>
                                                <td>
                                                    ${e.ajustesNEE?.map(a => `
                                                        <span class="badge badge-warning">${a}</span>
                                                    `).join(' ') || 'Ninguno'}
                                                </td>
                                                <td class="actions">
                                                    <button class="btn btn-sm btn-primary" onclick="app.configurarNEE('${e.id}')">Configurar</button>
                                                    <button class="btn btn-sm btn-secondary" onclick="app.verReporteNEE('${e.id}')">Reporte</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">Configuración de Ajustes NEE</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong>Tipos de ajustes disponibles:</strong>
                                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                                    <li>Ajuste de ponderaciones (reducir porcentajes)</li>
                                    <li>Exclusión de componentes específicos</li>
                                    <li>Adaptaciones en instrumentos de evaluación</li>
                                    <li>Tiempo extendido para evaluaciones</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderIndicadores() {
                const indicadores = await this.indicadorService.getAll();
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Banco de Indicadores</h3>
                            <div class="d-flex gap-2">
                                <button class="btn btn-secondary" onclick="app.importarIndicadores()">
                                    Importar CSV
                                </button>
                                <button class="btn btn-primary" onclick="app.showModalCrearIndicador()">
                                    + Nuevo Indicador
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Descripción</th>
                                            <th>Clasificación</th>
                                            <th>Competencia</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${indicadores.length === 0 ? `
                                            <tr>
                                                <td colspan="5" class="text-center">No hay indicadores registrados</td>
                                            </tr>
                                        ` : indicadores.map(ind => `
                                            <tr>
                                                <td>${ind.codigo}</td>
                                                <td>${ind.descripcion}</td>
                                                <td><span class="badge badge-info">${ind.clasificacion}</span></td>
                                                <td>${ind.competencia}</td>
                                                <td class="actions">
                                                    <button class="btn btn-sm btn-primary" onclick="app.editarIndicador('${ind.id}')">Editar</button>
                                                    <button class="btn btn-sm btn-danger" onclick="app.eliminarIndicador('${ind.id}')">Eliminar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderReportes() {
                const grupos = await this.estudianteService.getGrupos();
                
                return `
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Reporte Individual</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Seleccionar Estudiante</label>
                                    <select class="form-control" id="reporteEstudiante">
                                        <option value="">Buscar...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tipo de Reporte</label>
                                    <select class="form-control" id="tipoReporteInd">
                                        <option value="completo">Reporte Completo</option>
                                        <option value="boleta">Boleta de Calificaciones</option>
                                        <option value="historial">Historial Académico</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="app.generarReporteIndividual()" style="width: 100%;">
                                    Generar Reporte
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Reporte Grupal</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Seleccionar Grupo</label>
                                    <select class="form-control" id="reporteGrupo">
                                        <option value="">Seleccione...</option>
                                        ${grupos.map(g => `<option value="${g.id}">${g.codigo}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Periodo</label>
                                    <select class="form-control" id="reportePeriodoGrupo">
                                        <option value="anual">Anual</option>
                                        <option value="1">Periodo 1</option>
                                        <option value="2">Periodo 2</option>
                                        <option value="3">Periodo 3</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="app.generarReporteGrupal()" style="width: 100%;">
                                    Generar Reporte Grupal
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">Estadísticas y Análisis</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-3">
                                <button class="btn btn-secondary" onclick="app.exportarReporte('PDF')">
                                    Exportar a PDF
                                </button>
                                <button class="btn btn-secondary" onclick="app.exportarReporte('Excel')">
                                    Exportar a Excel
                                </button>
                                <button class="btn btn-secondary" onclick="app.exportarReporte('CSV')">
                                    Exportar a CSV
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderExportar() {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Exportación Compatible SEA - MEP Costa Rica</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong>Formato SEA:</strong> Esta exportación genera un archivo CSV estructurado 
                                según los requisitos del Sistema de Evaluación y Acreditación del MEP Costa Rica.
                            </div>

                            <div class="form-group">
                                <label class="form-label">Año Lectivo</label>
                                <input type="number" class="form-control" id="seaAño" value="${CONFIG.DEFAULT_YEAR}">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Configuración de Decimales</label>
                                <select class="form-control" id="seaDecimales">
                                    <option value="0">Sin decimales</option>
                                    <option value="1">1 decimal</option>
                                    <option value="2" selected>2 decimales</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="toggle">
                                    <input type="checkbox" id="seaValidar" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="margin-left: 0.5rem;">Validar rangos de notas antes de exportar</span>
                            </div>

                            <div class="d-flex gap-2" style="margin-top: 1.5rem;">
                                <button class="btn btn-primary" onclick="app.exportarSEA()">
                                    Generar Archivo SEA
                                </button>
                                <button class="btn btn-secondary" onclick="app.validarDatosSEA()">
                                    Validar Datos
                                </button>
                            </div>

                            <div id="seaResultado" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>
                `;
            }

            async renderUsuarios() {
                const users = await db.getAll('users');
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Gestión de Usuarios</h3>
                            <button class="btn btn-primary" onclick="app.showModalCrearUsuario()">
                                + Nuevo Usuario
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${users.map(u => `
                                            <tr>
                                                <td>${u.nombre} ${u.apellidos}</td>
                                                <td>${u.email}</td>
                                                <td><span class="badge badge-info">${u.rol}</span></td>
                                                <td>
                                                    ${u.active ? 
                                                        '<span class="badge badge-success">Activo</span>' : 
                                                        '<span class="badge badge-danger">Inactivo</span>'}
                                                </td>
                                                <td class="actions">
                                                    <button class="btn btn-sm btn-primary" onclick="app.editarUsuario('${u.id}')">Editar</button>
                                                    <button class="btn btn-sm btn-danger" onclick="app.toggleUsuario('${u.id}')">
                                                        ${u.active ? 'Desactivar' : 'Activar'}
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderRespaldo() {
                return `
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Exportar Respaldo</h3>
                            </div>
                            <div class="card-body">
                                <p style="margin-bottom: 1rem; color: var(--secondary);">
                                    Genere un archivo JSON completo con todos los datos del sistema.
                                    Guárdelo en un lugar seguro.
                                </p>
                                <button class="btn btn-primary" onclick="app.exportarBackup()" style="width: 100%;">
                                    Descargar Respaldo Completo
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Importar Respaldo</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                                    <strong>Advertencia:</strong> Esta acción sobrescribirá todos los datos actuales.
                                    Asegúrese de tener un respaldo reciente.
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Archivo de Respaldo (.json)</label>
                                    <input type="file" class="form-control" id="backupFile" accept=".json">
                                </div>
                                <button class="btn btn-danger" onclick="app.importarBackup()" style="width: 100%;">
                                    Restaurar desde Respaldo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">Información del Sistema</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-2">
                                <div>
                                    <p><strong>Versión:</strong> ${CONFIG.APP_VERSION}</p>
                                    <p><strong>Base de Datos:</strong> ${CONFIG.DB_NAME}</p>
                                </div>
                                <div>
                                    <p><strong>Modo:</strong> <span class="badge badge-success">Offline Ready</span></p>
                                    <p><strong>Último Respaldo:</strong> <span id="lastBackup">Nunca</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Acciones específicas
            async cargarEstudiantesEval() {
                const grupoId = document.getElementById('evalGrupo').value;
                if (!grupoId) return;

                const estudiantes = await this.estudianteService.getEstudiantesByGrupo(grupoId);
                const container = document.getElementById('tablaEvaluacion');
                
                if (estudiantes.length === 0) {
                    container.innerHTML = '<p class="text-center">No hay estudiantes en este grupo</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Identificación</th>
                                    <th>Nota (0-100)</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${estudiantes.map(e => `
                                    <tr>
                                        <td>${e.nombre} ${e.apellidos}</td>
                                        <td>${e.identificacion}</td>
                                        <td>
                                            <input type="number" class="form-control" 
                                                id="nota_${e.id}" min="0" max="100" step="0.01"
                                                style="width: 100px;">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" 
                                                id="obs_${e.id}" placeholder="Opcional">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button class="btn btn-primary" onclick="app.guardarEvaluaciones()">
                            Guardar Evaluaciones
                        </button>
                    </div>
                `;
            }

            async guardarEvaluaciones() {
                const grupoId = document.getElementById('evalGrupo').value;
                const periodo = parseInt(document.getElementById('evalPeriodo').value);
                const componente = document.getElementById('evalComponente').value;
                
                const estudiantes = await this.estudianteService.getEstudiantesByGrupo(grupoId);
                let guardadas = 0;

                for (const est of estudiantes) {
                    const notaInput = document.getElementById(`nota_${est.id}`);
                    const nota = parseFloat(notaInput.value);
                    
                    if (!isNaN(nota)) {
                        try {
                            await this.evaluacionService.registrarEvaluacion({
                                estudianteId: est.id,
                                grupoId,
                                periodo,
                                componente,
                                nota,
                                observaciones: document.getElementById(`obs_${est.id}`).value,
                                docenteId: this.auth.currentUser.id
                            });
                            guardadas++;
                        } catch (error) {
                            console.error(`Error guardando evaluación para ${est.nombre}:`, error);
                        }
                    }
                }

                this.showToast(`${guardadas} evaluaciones guardadas exitosamente`, 'success');
            }

            async exportarSEA() {
                try {
                    const datos = await this.seaService.exportarDatos();
                    const validacion = this.seaService.validarDatosSEA(datos);
                    
                    if (!validacion.valido) {
                        document.getElementById('seaResultado').innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Errores de validación:</strong>
                                <ul>${validacion.errores.map(e => `<li>${e}</li>`).join('')}</ul>
                            </div>
                        `;
                        return;
                    }

                    const csv = this.seaService.generarCSV(datos);
                    const año = document.getElementById('seaAño').value;
                    utils.downloadFile(csv, `SEA_Export_${año}.csv`, 'text/csv');
                    
                    this.showToast('Exportación SEA completada', 'success');
                } catch (error) {
                    this.showToast('Error en exportación: ' + error.message, 'error');
                }
            }

            async exportarBackup() {
                try {
                    const backup = await this.backupService.exportarBackup();
                    const fecha = new Date().toISOString().split('T')[0];
                    utils.downloadFile(backup, `Idonet_Backup_${fecha}.json`, 'application/json');
                    this.showToast('Respaldo exportado exitosamente', 'success');
                } catch (error) {
                    this.showToast('Error al exportar: ' + error.message, 'error');
                }
            }

            async importarBackup() {
                const fileInput = document.getElementById('backupFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    this.showToast('Seleccione un archivo de respaldo', 'warning');
                    return;
                }

                try {
                    const content = await file.text();
                    await this.backupService.importarBackup(content);
                    this.showToast('Respaldo restaurado exitosamente', 'success');
                    this.navigate('dashboard');
                } catch (error) {
                    this.showToast(error.message, 'error');
                }
            }

            // UI Helpers
            showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span>${type === 'success' ? '✓' : type === 'error' ? '✗' : '⚠'}</span>
                    <span>${message}</span>
                `;
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            showModal(title, content, onConfirm) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
                document.getElementById('modalOverlay').classList.add('active');
                
                const confirmBtn = document.getElementById('modalConfirm');
                confirmBtn.onclick = () => {
                    onConfirm();
                    this.closeModal();
                };
            }

            closeModal(event) {
                if (!event || event.target.id === 'modalOverlay') {
                    document.getElementById('modalOverlay').classList.remove('active');
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('open');
            }

            // Placeholders para funciones adicionales
            showModalCrearGrupo() { this.showToast('Función en desarrollo', 'warning'); }
            verEstudiantes(id) { this.showToast('Cargando estudiantes...', 'info'); }
            editarGrupo(id) { this.showToast('Editando grupo...', 'info'); }
            eliminarGrupo(id) { 
                if (confirm('¿Eliminar este grupo?')) {
                    this.showToast('Grupo eliminado', 'success');
                }
            }
            showModalCrearRubrica() { this.showToast('Creando rúbrica...', 'info'); }
            aplicarRubrica(id) { this.showToast('Aplicando rúbrica...', 'info'); }
            editarRubrica(id) { this.showToast('Editando rúbrica...', 'info'); }
            configurarNEE(id) { this.showToast('Configurando NEE...', 'info'); }
            verReporteNEE(id) { this.showToast('Generando reporte NEE...', 'info'); }
            showModalCrearIndicador() { this.showToast('Creando indicador...', 'info'); }
            importarIndicadores() { this.showToast('Importando...', 'info'); }
            editarIndicador(id) { this.showToast('Editando...', 'info'); }
            eliminarIndicador(id) { this.showToast('Eliminando...', 'info'); }
            generarReporteIndividual() { this.showToast('Generando reporte...', 'info'); }
            generarReporteGrupal() { this.showToast('Generando reporte grupal...', 'info'); }
            exportarReporte(formato) { this.showToast(`Exportando a ${formato}...`, 'info'); }
            showModalCrearUsuario() { this.showToast('Creando usuario...', 'info'); }
            editarUsuario(id) { this.showToast('Editando usuario...', 'info'); }
            toggleUsuario(id) { this.showToast('Cambiando estado...', 'info'); }
            validarDatosSEA() { this.showToast('Validando datos SEA...', 'info'); }
        }

        // Inicializar aplicación
        const app = new App();
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
